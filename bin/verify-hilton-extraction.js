require('dotenv').config({ path: '.env.local' });
const { createClient } = require('@supabase/supabase-js');

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

async function verifyExtraction() {
  console.log('\nðŸ” HILTON GARDEN INN GOA - EXTRACTION VERIFICATION\n');

  // Find the hotel
  const { data: hotel, error: hotelError } = await supabase
    .from('hotels')
    .select('*')
    .ilike('name', '%hilton%garden%')
    .single();

  if (hotelError || !hotel) {
    console.log('âŒ Hotel not found:', hotelError?.message || 'Not found');
    return;
  }

  console.log(`âœ… Found: ${hotel.name}`);
  console.log(`   Slug: ${hotel.slug}`);
  console.log(`   Status: ${hotel.extraction_status}\n`);

  // ========================================
  // SECTION 1: BASIC INFO
  // ========================================
  console.log('ðŸ“‹ BASIC INFORMATION:');
  console.log(`   Name: ${hotel.name || 'âŒ MISSING'}`);
  console.log(`   Area: ${hotel.area || 'âŒ MISSING'}`);
  console.log(`   Address: ${hotel.address || 'âŒ MISSING'}`);
  console.log(`   Phone: ${hotel.phone || 'âŒ MISSING'}`);
  console.log(`   Website: ${hotel.website || 'âŒ MISSING'}`);
  console.log(`   Star Rating: ${hotel.star_rating || 'âŒ MISSING'}`);

  // ========================================
  // SECTION 2: AI-GENERATED CONTENT
  // ========================================
  console.log('\nâœ¨ AI-GENERATED CONTENT:');
  console.log(`   Description: ${hotel.description ? 'âœ… ' + hotel.description.substring(0, 80) + '...' : 'âŒ MISSING'}`);
  console.log(`   Short Description: ${hotel.short_description ? 'âœ… ' + hotel.short_description.substring(0, 60) + '...' : 'âŒ MISSING'}`);
  console.log(`   Meta Title: ${hotel.meta_title || 'âŒ MISSING'}`);
  console.log(`   Meta Description: ${hotel.meta_description ? hotel.meta_description.substring(0, 80) + '...' : 'âŒ MISSING'}`);
  console.log(`   Review Sentiment: ${hotel.review_sentiment ? 'âœ… ' + hotel.review_sentiment.substring(0, 80) + '...' : 'âŒ MISSING'}`);

  // ========================================
  // SECTION 3: CATEGORIES & AMENITIES
  // ========================================
  console.log('\nðŸ·ï¸  CATEGORIES & AMENITIES:');
  console.log(`   Category IDs: ${hotel.hotel_category_ids?.length || 0} matched`);
  console.log(`   Amenity IDs: ${hotel.hotel_amenity_ids?.length || 0} matched`);
  console.log(`   Facility IDs: ${hotel.hotel_facility_ids?.length || 0} matched`);

  if (hotel.hotel_category_ids && hotel.hotel_category_ids.length > 0) {
    const { data: categories } = await supabase
      .from('hotel_categories')
      .select('name')
      .in('id', hotel.hotel_category_ids);
    console.log(`   Categories: ${categories?.map(c => c.name).join(', ')}`);
  }

  if (hotel.hotel_amenity_ids && hotel.hotel_amenity_ids.length > 0) {
    const { data: amenities } = await supabase
      .from('hotel_amenities')
      .select('name')
      .in('id', hotel.hotel_amenity_ids);
    console.log(`   Amenities: ${amenities?.map(a => a.name).join(', ')}`);
  }

  // ========================================
  // SECTION 4: IMAGES (CRITICAL - NEW HOTEL EXTRACTOR)
  // ========================================
  console.log('\nðŸ“¸ IMAGES (Hotel-Specific Vision API):');
  console.log(`   Hero Image: ${hotel.hero_image ? 'âœ… SET' : 'âŒ NOT SET'}`);
  if (hotel.hero_image) {
    console.log(`   Hero URL: ${hotel.hero_image.substring(0, 80)}...`);
  }

  const { data: images, count: imageCount } = await supabase
    .from('hotel_images')
    .select('*', { count: 'exact' })
    .eq('hotel_id', hotel.id)
    .order('hero_score', { ascending: false });

  console.log(`   Total Images: ${imageCount || 0}`);

  if (images && images.length > 0) {
    console.log('\n   Image Details:');
    images.slice(0, 5).forEach((img, idx) => {
      console.log(`   ${idx + 1}. ${img.is_hero ? 'â­ HERO' : '  '} Score: ${img.hero_score || 0} | ${img.alt_text?.substring(0, 60) || 'No alt text'}...`);
      console.log(`      Content: ${img.content_descriptor || 'N/A'}`);
      console.log(`      Size: ${img.width}x${img.height} | ${img.file_size_kb}kb`);
    });
  } else {
    console.log('   âŒ NO IMAGES FOUND - Vision API may have failed');
  }

  // ========================================
  // SECTION 5: FAQS (NEW - STEP 12)
  // ========================================
  console.log('\nâ“ FAQS (Generated by OpenAI):');
  const { data: faqs, count: faqCount } = await supabase
    .from('hotel_faqs')
    .select('*', { count: 'exact' })
    .eq('hotel_id', hotel.id)
    .order('relevance_score', { ascending: false });

  console.log(`   Total FAQs: ${faqCount || 0}`);

  if (faqs && faqs.length > 0) {
    console.log('\n   Sample FAQs:');
    faqs.slice(0, 3).forEach((faq, idx) => {
      console.log(`   ${idx + 1}. Q: ${faq.question}`);
      console.log(`      A: ${faq.answer.substring(0, 100)}...`);
      console.log(`      Category: ${faq.category} | Relevance: ${faq.relevance_score}`);
    });
  } else {
    console.log('   âŒ NO FAQS GENERATED - OpenAI may have failed');
  }

  // ========================================
  // SECTION 6: ROOMS (NEW - STEP 12)
  // ========================================
  console.log('\nðŸ›ï¸  ROOMS (Extracted from Firecrawl):');
  const { data: rooms, count: roomCount } = await supabase
    .from('hotel_rooms')
    .select('*', { count: 'exact' })
    .eq('hotel_id', hotel.id);

  console.log(`   Total Rooms: ${roomCount || 0}`);

  if (rooms && rooms.length > 0) {
    console.log('\n   Room Types:');
    rooms.forEach((room, idx) => {
      console.log(`   ${idx + 1}. ${room.name} (${room.room_type})`);
      console.log(`      Max Occupancy: ${room.max_occupancy} | ${room.bed_configuration}`);
      console.log(`      Size: ${room.size_sqm ? room.size_sqm + ' sqm' : 'N/A'}`);
      console.log(`      Amenities: ${room.amenities?.join(', ') || 'None'}`);
    });
  } else {
    console.log('   âš ï¸  NO ROOMS FOUND - May not have room data on website');
  }

  // ========================================
  // SECTION 7: POLICIES (NEW - STEP 12)
  // ========================================
  console.log('\nðŸ“œ POLICIES (Extracted from hotel data):');
  const { data: policies, count: policyCount } = await supabase
    .from('hotel_policies')
    .select('*', { count: 'exact' })
    .eq('hotel_id', hotel.id);

  console.log(`   Total Policies: ${policyCount || 0}`);

  if (policies && policies.length > 0) {
    policies.forEach((policy, idx) => {
      console.log(`   ${idx + 1}. ${policy.policy_type.toUpperCase()}`);
      console.log(`      ${policy.description}`);
    });
  } else {
    console.log('   âš ï¸  NO POLICIES FOUND');
  }

  // ========================================
  // SECTION 8: SOCIAL MEDIA
  // ========================================
  console.log('\nðŸŒ SOCIAL MEDIA:');
  console.log(`   Instagram: ${hotel.instagram || 'âŒ Not found'}`);
  console.log(`   Facebook: ${hotel.facebook || 'âŒ Not found'}`);
  console.log(`   TikTok: ${hotel.tiktok || 'âŒ Not found'}`);
  console.log(`   Twitter: ${hotel.twitter || 'âŒ Not found'}`);
  console.log(`   YouTube: ${hotel.youtube || 'âŒ Not found'}`);

  // ========================================
  // SECTION 9: REVIEWS & RATINGS
  // ========================================
  console.log('\nâ­ REVIEWS & RATINGS:');
  console.log(`   Average Rating: ${hotel.average_rating || 'N/A'}`);
  console.log(`   Review Count: ${hotel.review_count || 0}`);

  // ========================================
  // SECTION 10: EXTRACTION PROGRESS
  // ========================================
  console.log('\nðŸ“Š EXTRACTION PROGRESS:');
  if (hotel.extraction_progress && hotel.extraction_progress.steps) {
    const steps = hotel.extraction_progress.steps;
    steps.forEach(step => {
      const icon = step.status === 'completed' ? 'âœ…' : step.status === 'failed' ? 'âŒ' : 'â³';
      console.log(`   ${icon} Step ${step.step}: ${step.name} (${step.status})`);
      if (step.error) {
        console.log(`      âš ï¸  Error: ${step.error}`);
      }
    });
  }

  // ========================================
  // FINAL SUMMARY
  // ========================================
  console.log('\n' + '='.repeat(60));
  console.log('ðŸ“Š EXTRACTION SUMMARY:');
  console.log('='.repeat(60));

  const checks = {
    'Description': !!hotel.description,
    'Categories Matched': (hotel.hotel_category_ids?.length || 0) > 0,
    'Amenities Matched': (hotel.hotel_amenity_ids?.length || 0) > 0,
    'Hero Image Set': !!hotel.hero_image,
    'Images Extracted': (imageCount || 0) > 0,
    'FAQs Generated': (faqCount || 0) > 0,
    'Rooms Extracted': (roomCount || 0) > 0,
    'Policies Created': (policyCount || 0) > 0,
    'Social Media Found': !!(hotel.instagram || hotel.facebook),
  };

  Object.entries(checks).forEach(([check, passed]) => {
    console.log(`   ${passed ? 'âœ…' : 'âŒ'} ${check}`);
  });

  const passedCount = Object.values(checks).filter(v => v).length;
  const totalCount = Object.keys(checks).length;
  const percentage = Math.round((passedCount / totalCount) * 100);

  console.log('\n' + '='.repeat(60));
  console.log(`ðŸŽ¯ OVERALL SCORE: ${passedCount}/${totalCount} (${percentage}%)`);
  console.log('='.repeat(60) + '\n');

  if (percentage === 100) {
    console.log('ðŸŽ‰ PERFECT EXTRACTION! All systems working correctly.\n');
  } else if (percentage >= 70) {
    console.log('âœ… GOOD EXTRACTION! Some optional data missing.\n');
  } else {
    console.log('âš ï¸  INCOMPLETE EXTRACTION! Review errors above.\n');
  }
}

verifyExtraction().catch(console.error);
